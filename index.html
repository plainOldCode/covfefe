<!DOCTYPE html>
<html>
<head>
	<title>Welcome to Vue</title>
	<script src="https://unpkg.com/vue"></script>
	<script type="text/javascript" src="./bundle.js"></script>
</head>
<body>
<div id="app">
    <!-- <button v-on="click: addNewElement()">Add Element</button> 
    <br />-->
</div>
<script>
	let buttonIdCounter = 0;
	function getButtonId() {
		return 'myButton'+(buttonIdCounter++);
	}
	let Buttons = [];

	function addNewElement ( buttonId ) {
		let n = new document.NodeBox({ step : (v) => v+1 }),
			s = new document.StoreBox({}),
			c = new document.StoreControl({});

		s.pull(n);
		c.watch(s);
		c.input = function( store ) {
			console.log(store);
			if (store.ordered.length == 5) {
				addNewElement( getButtonId() );
				store.ordered = [];
			}
			tmp.counter();

			if (Buttons.length > 5) {
				let a = Buttons.filter( (v)=> v.buttonId === c.buttonId);
				Buttons.filter( (v) => v.buttonId !== c.buttonId).forEach( (v) => {
						let elem = document.getElementById(v.buttonId);
						elem.parentElement.removeChild(elem);
						v.storeControl.halt();
						v.store.halt();
						v.node.halt();
					});
				Buttons = a;
			}
		};
		c.buttonId = buttonId;

		var MyComponent = Vue.extend({
			template: '<button id="'+buttonId+'" v-on:click="give(1)"> Click '+buttonId+' {{ count }}</button>',
			data : function () {
				return {
					count : 0
				}
			},
		  	methods : {
				give : function(number) {
					n.input(number);
					//this.counter();
				},
				counter : function () {
					this.count = s.ordered.length;
				}
			}
		})

		var tmp = new MyComponent().$mount();
		document.getElementById('app').appendChild(tmp.$el);
		Buttons.push({
			buttonId : buttonId,
			node : n,
			store : s,
			storeControl : c
		});
	}

	const v = new Vue({
		el: '#app',
		methods:{
			addNewElement: addNewElement
		}
	});

	v.addNewElement( getButtonId() );
</script>
</body>
</html>
